#!/usr/bin/env python3
"""
GitHub PR Review Analysis CLI

Analyze GitHub PR reviews for a user using LangGraph workflow and Vertex AI.

Usage:
    gh-analyze -n <name> -p <period> [options]
    gh-analyze -u <username> -s <start-date> -e <end-date> [options]
    gh-analyze -n <name> -s <start-date> -e <end-date> [options]
    gh-analyze -u <username> -p <period> [options]

Examples:
    # Using slugified name and period (RECOMMENDED - no quotes needed!)
    gh-analyze -n varun-sundar -p 2025H2          # Second half of 2025
    gh-analyze -n ariel-ledesma -p 2025H1        # First half of 2025
    gh-analyze -n erin-friesen -p 2026Q1         # First quarter of 2026
    gh-analyze -n varun-sundar -p 2025           # Full year 2025

    # Alternative: Using full name (requires quotes for spaces)
    gh-analyze -n "Varun Sundar" -p 2025H2

    # Using username and dates
    gh-analyze -u varunsundar -s 2025-07-01 -e 2025-12-31
    gh-analyze -u ariel-ledesma-eiq -s 2025-07-01 -e 2025-12-31

    # Mixed: slugified name with dates, or username with period
    gh-analyze -n varun-sundar -s 2025-07-01 -e 2025-12-31
    gh-analyze -u varunsundar -p 2025H2

Options:
    -n, --name NAME       Person's name in slugified format (e.g., varun-sundar).
                          Full names with spaces (e.g., "Varun Sundar") are also
                          supported but require quotes. Slugified format is recommended.
    -u, --username USERNAME   GitHub username
    -p, --period PERIOD   Period string: YYYYH1, YYYYH2, YYYYQ1-Q4, or YYYY
                          (e.g., "2025H2", "2026Q1", "2025")
    -s, --start DATE      Start date (YYYY-MM-DD)
    -e, --end DATE        End date (YYYY-MM-DD)
    --org ORG             Organization name (default: EvolutionIQ)
    -o, --output DIR      Output directory (default: reports/<slugified-name>/<period>)
    --github-token TOKEN  GitHub token (or set GITHUB_TOKEN env var)
    --project PROJECT     Google Cloud project (or set GOOGLE_CLOUD_PROJECT env var)
    --location LOCATION   Vertex AI location (default: us-east4)

Note: Provide either (name OR username) AND (period OR start+end dates)
"""

import argparse
import os
import sys
import traceback
from datetime import datetime
from pathlib import Path

# Load environment variables from .env file if it exists
try:
    from dotenv import load_dotenv

    load_dotenv()
except ImportError:
    # python-dotenv not installed, skip loading .env
    pass

# Import shared utilities
sys.path.insert(0, str(Path(__file__).parent))
from shared.cli_utils import (
    determine_output_dir,
    resolve_time_range,
    resolve_user_identity,
)
from shared.config_utils import (
    create_github_config,
    load_centralized_config,
    user_exists_in_config,
)


def validate_date(date_str: str) -> str:
    """Validate and return date string in YYYY-MM-DD format."""
    try:
        datetime.strptime(date_str, "%Y-%m-%d")
        return date_str
    except ValueError as err:
        raise argparse.ArgumentTypeError(
            f"Invalid date format: {date_str}. Use YYYY-MM-DD"
        ) from err


def _resolve_user_identity(
    name: str | None,
    username: str | None,
    config_data: dict | None,
    parser: argparse.ArgumentParser,
) -> tuple[str | None, str]:
    """Resolve name and username from arguments and config (GitHub-specific)."""
    return resolve_user_identity(name, username, config_data, parser, prefer_email=False)


def main():
    parser = argparse.ArgumentParser(
        description="Analyze GitHub PR reviews for a user",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog=__doc__,
    )

    # Name/username options (mutually complementary)
    parser.add_argument(
        "-n",
        "--name",
        help="Person's name in slugified format (e.g., 'varun-sundar'). Full names with spaces are also supported but require quotes.",
    )
    parser.add_argument("-u", "--username", help="GitHub username")

    # Period/dates options (mutually complementary)
    parser.add_argument("-p", "--period", help="Period key (e.g., '2025H2')")
    parser.add_argument("-s", "--start", type=validate_date, help="Start date (YYYY-MM-DD)")
    parser.add_argument("-e", "--end", type=validate_date, help="End date (YYYY-MM-DD)")

    # Common options
    parser.add_argument(
        "--org", default="EvolutionIQ", help="Organization name (default: EvolutionIQ)"
    )
    parser.add_argument(
        "-o", "--output", help="Output directory (default: reports/<slugified-name>/<period>)"
    )
    parser.add_argument("--github-token", help="GitHub API token (or set GITHUB_TOKEN env var)")
    parser.add_argument(
        "--project", help="Google Cloud project (or set GOOGLE_CLOUD_PROJECT env var)"
    )
    parser.add_argument(
        "--location", default="us-east4", help="Vertex AI location (default: us-east4)"
    )

    args = parser.parse_args()

    # Validate: need at least one of (name OR username) AND one of (period OR start+end)
    has_identifier = bool(args.name or args.username)
    has_time_range = bool(args.period or (args.start and args.end))

    if not has_identifier:
        parser.error("Must provide either -n/--name or --username")

    if not has_time_range:
        parser.error("Must provide either -p/--period or both --start and --end")

    if args.period and (args.start or args.end):
        parser.error("Cannot provide both -p/--period and --start/--end")

    # Load centralized config if it exists
    script_dir = Path(__file__).parent
    centralized_config = script_dir / "config.json"
    config_data = load_centralized_config(centralized_config)

    # Resolve name and username
    name, username = _resolve_user_identity(args.name, args.username, config_data, parser)

    # Resolve period and dates
    period_key, start_date, end_date = resolve_time_range(
        args.period, args.start, args.end, config_data, parser
    )

    # Validate credentials
    github_token = args.github_token or os.getenv("GITHUB_TOKEN")
    vertexai_project = args.project or os.getenv("GOOGLE_CLOUD_PROJECT")

    if not github_token:
        parser.error(
            "GitHub token required. Set --github-token or GITHUB_TOKEN environment variable"
        )

    if not vertexai_project:
        parser.error(
            "Google Cloud project required. Set --project or GOOGLE_CLOUD_PROJECT environment variable"
        )

    # Determine output directory
    output_dir = determine_output_dir(args.output, name, username, period_key)

    # Create config file
    print(f"\n{'=' * 60}")
    print("GitHub PR Review Analysis")
    print(f"{'=' * 60}")
    print(f"Username: {username}")
    if name:
        print(f"Name: {name}")
    print(f"Period: {start_date} to {end_date} ({period_key})")
    print(f"Organization: {args.org}")
    print(f"Output: {output_dir}")
    print(f"{'=' * 60}\n")

    if centralized_config.exists() and config_data and user_exists_in_config(config_data, username):
        # Use centralized config
        config_file = centralized_config
        print(f"Using centralized config: {config_file}")
    else:
        # Create individual config
        config_file = create_github_config(
            username, start_date, end_date, args.org, Path(output_dir)
        )

    # Import and run workflow
    # These are already validated above, but ty needs explicit checks
    if github_token is None:
        parser.error("GitHub token is required")
    if vertexai_project is None:
        parser.error("Google Cloud project is required")
    # Type narrowing: ty now knows these are not None
    assert github_token is not None
    assert vertexai_project is not None
    _run_workflow(
        script_dir,
        config_file,
        github_token,
        vertexai_project,
        args.location,
        username,
        period_key,
        output_dir,
    )


def _run_workflow(
    script_dir: Path,
    config_file: Path,
    github_token: str,
    vertexai_project: str,
    vertexai_location: str,
    username: str,
    period_key: str,
    output_dir: str,
) -> None:
    """Import and execute the LangGraph workflow."""
    workflow_dir = script_dir / "pr-review-analysis" / "workflows"
    sys.path.insert(0, str(workflow_dir))

    from analyze import run  # type: ignore[import-untyped]

    try:
        result = run(
            config_path=str(config_file),
            github_token=github_token,
            vertexai_project=vertexai_project,
            vertexai_location=vertexai_location,
            username=username if config_file.name == "config.json" else None,
            period=period_key if config_file.name == "config.json" else None,
            output_dir=output_dir,
        )

        print(f"\n{'=' * 60}")
        print("✓ Analysis Complete!")
        print(f"{'=' * 60}")
        print(f"Report: {result['output_dir']}/github-review-analysis.md")
        print(f"Config: {config_file}")

    except Exception as e:
        print(f"\n❌ Error: {e}")
        traceback.print_exc()
        sys.exit(1)


if __name__ == "__main__":
    main()
